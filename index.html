<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XHR and Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1 style="font-family: Arial, Helvetica, sans-serif;text-align: center;">Catalonia Vehicular Car Crashes 2000 to 2011 Each Day of the Week</h1>
    <canvas id="myChart" width="400" height="200"></canvas>
    <script>
        window.addEventListener('load', fetchData);
        function fetchData(){
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:3000/csv-data', true);
        xhr.onreadystatechange = function(){
            if (xhr.readyState === 4 && xhr.status === 200){
                let data = xhr.responseText;
                let carCrashes = processData(data);
                renderChart(carCrashes);
            } else {
                console.log('something bad happened', xhr.statusText);
            }
        } 
        xhr.send();
    }
    function processData(data){
        const days = [];
        const crashes= [];
        const rows = data.split('\n').slice(1);
        rows.forEach(row => {
            const cols = row.split(',');
            days.push(cols[0]);
            crashes.push(14 + parseFloat(cols[1]));
        });
        return{ days, crashes };
    }
    function renderChart(data){
        console.log('crashes in renderChart', data);
         const ctx = document.getElementById('myChart');

  const myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.days,
      datasets: [{
        label: 'Car Crashes in Catalonia',
        data: data.crashes,
        borderWidth: 3
      }]
    },
    options: {
        scales:{
            y: {
                beginAtZero: true
            }
        }
    }
  });
    };
    </script>
</body>
</html>